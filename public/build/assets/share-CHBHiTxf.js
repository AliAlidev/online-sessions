import{g as f}from"./auth-CrJnzGtq.js";async function E(){var e=$("#global-event-data").val(),t=$("#global-event-data").data("eventGalleryUrl");if($("#global-event-data").data("eventHasP"))if(localStorage.getItem(e)){var a=await f();axios.post(t,{_token:document.querySelector('meta[name="csrf-token"]').getAttribute("content"),password:localStorage.getItem(e)},{headers:{pageToken:a}}).then(n=>{n.data.success?setTimeout(()=>{document.querySelector(".main-container").classList.remove("auth-checking"),v()},5):p()}).catch(n=>{p()})}else p();else setTimeout(()=>{document.querySelector(".main-container").classList.remove("auth-checking"),v()},5)}async function k(){var t,a;const e=await f();try{if(!(await fetch("/events/check-token",{method:"GET",headers:{pageToken:e}})).ok)throw new Error("Unauthorized");E()}catch{window.location.href=((a=(t=document.getElementById("main-page-url"))==null?void 0:t.dataset)==null?void 0:a.url)||"/"}}k();function v(){const e=document.getElementById("page-loader");e&&(e.style.display="none")}async function p(){var e=$("#global-event-data").data("url"),t=await f();axios.get(e,{headers:{pageToken:t}}).then(a=>{window.location.href=a.data.url}).catch(a=>{console.log(a)})}const c=document.getElementById("dropArea"),u=document.getElementById("image"),m=document.getElementById("thumbnails");c.addEventListener("click",()=>{u.click()});u.addEventListener("change",b);c.addEventListener("dragover",e=>{e.preventDefault(),c.classList.add("dragover")});c.addEventListener("dragleave",()=>{c.classList.remove("dragover")});c.addEventListener("drop",e=>{e.preventDefault(),c.classList.remove("dragover"),u.files=e.dataTransfer.files,b()});function b(){const e=u.files;if(m.innerHTML="",e.length>0){m.style.marginTop="15px";for(const t of e)if(t&&t.type.startsWith("image/")){const a=new FileReader;a.onload=function(n){const i=document.createElement("img");i.src=n.target.result,m.appendChild(i)},a.readAsDataURL(t)}}else m.style.marginTop="0"}function B(){const e=document.getElementById("overlay");e.classList.remove("show"),e.addEventListener("transitionend",()=>{e.classList.add("hidden")},{once:!0})}document.getElementById("closeModalBtn").addEventListener("click",B);document.getElementById("closeXBtn").addEventListener("click",B);$("#uploadForm").submit(async function(e){e.preventDefault(),$(".alert").remove(),$(".image-error").attr("hidden",!0);var t=$("#storeButton");x(t),await S();var a=$("#image-compressed")[0].files[0];if(!a)return $(".image-error").attr("hidden",!1),$(".image-error").text("Please select image"),g(t),!1;$(".upload-image-btn").attr("disabled",!0),$("#closeModalBtn").attr("disabled",!0),y($(".upload-image-btn")),y($("#closeModalBtn"));var n=$("#uploadProgressModal #progressContainer");const i=document.getElementById("overlay");i.classList.remove("hidden"),setTimeout(()=>i.classList.add("show"),10),n.empty();let d=$(`
                <div class="mb-4" id="file-container-0" style="margin-top:10px">
                    <p class="mb-0">Stage1: File Upload ${a.name}</p>
                    <div class="progress" style="margin-top:10px">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                            style="width: 0%;" id="progress-bar-0"></div>
                    </div>
                    <div class='d-inline-block'>
                        <p id="status-0" class="text-danger mt-3" style="text-align:start; margin-top:10px"></p>
                        <button class="btn btn-sm btn-warning retry-btn hidden-force mt-3" style="height:15px; width:auto; font-size:12px; margin-top:10px; text-align:start" data-index="0">Retry</button>
                    </div>
                </div>
            `);n.append(d),w(a,0).then(s=>{var l;clearInterval($("#status-0").data("interval")),$("#progress-bar-0").removeClass("bg-success").addClass("bg-primary").text("Completed"),$("#status-0").addClass("hidden-force"),g(t),$("#uploadForm")[0].reset(),document.getElementById("thumbnails").innerHTML="";const o=((l=s.data)==null?void 0:l.message)||"Upload completed successfully",r=$(`<div class="alert alert-success guest-upload-success" style=""><i class="fa fa-check" aria-hidden="true"></i>${o}</div>`);$("#uploadProgressModal").prepend(r),$("#uploadProgressModalLabel").attr("hidden",!0),h($(".upload-image-btn")),h($("#closeModalBtn"))}).catch(s=>{g(t),console.error("Upload failed:",s)})});function y(e){e.attr("disabled",!0),e.css("background-color","grey")}function h(e){var t=$("#button-main-color").val();e.attr("disabled",!1),e.css("background-color",t)}async function w(e,t,a){let n=new FormData;n.append("file",e);var i=$('meta[name="csrf-token"]').attr("content"),d=$("#event_id").data("id");n.append("_token",i),n.append("user_name",$("#user_name").val()),n.append("description",$("#caption").val()),n.append("file_size",$("#file_size").val()),n.append("event_id",d);var s=document.getElementById("share-post-btn").dataset.url;$(`#file-container-${t} .start-btn`).remove();try{return await axios.post(s,n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:function(r){if(r.lengthComputable){const l=Math.round(r.loaded/r.total*100);$(`#progress-bar-${t}`).css("width",l+"%").text(l+"%"),l===100&&I(0)}},timeout:999e3})}catch(o){let r=$("#status-"+t);throw r.text("Stage2: Failed"),clearInterval(r.data("interval")),M(0),o}}function I(e){let t=$("#status-"+e),a=0;t.removeClass("hidden-force"),t.text("Stage2: Processing");let n=setInterval(()=>{a=(a+1)%4,t.text("Stage2: Processing"+".".repeat(a))},500);t.data("interval",n)}function M(e){$(`#file-container-${e} .retry-btn`).removeClass("hidden-force")}$(document).on("click",".retry-btn",function(e){e.preventDefault(),$(this).addClass("hidden-force");var t=$("#image-compressed")[0].files[0];$("#progress-bar-0").css("width","0%").removeClass("bg-danger").addClass("bg-success").text("0%"),$("#status-0").text("Stage2: Retrying..."),w(t,0)});function x(e){const t=document.getElementById("spinner");t.style.display="inline-block",e.disabled=!0}function g(e){const t=document.getElementById("spinner");t.style.display="none",e.disabled=!1}async function S(){const t=document.getElementById("image").files[0];if(!t)return;let a=[];try{const s=document.getElementById("compression-ratios-file-path"),o=await fetch(s.value);if(!o.ok)throw new Error(`Failed to fetch compression ratios: ${o.status}`);a=await o.json()}catch(s){console.error("Error loading compression ratios:",s),a=[{minSizeMB:10,quality:.7},{minSizeMB:9,quality:.75},{minSizeMB:8,quality:.8},{minSizeMB:7,quality:.85},{minSizeMB:6,quality:.9},{minSizeMB:5,quality:.91},{minSizeMB:4,quality:.92},{minSizeMB:3,quality:.93},{minSizeMB:2,quality:.94},{minSizeMB:1,quality:.95},{minSizeMB:.5,quality:.99}]}const n=new DataTransfer,i=t.size/(1024*1024);let d=null;for(const s of a)if(i>s.minSizeMB){d=Math.max(s.quality,.7);break}if(d===null){n.items.add(t),document.getElementById("image-compressed").files=n.files,document.getElementById("file_size").value=t.size;return}return new Promise((s,o)=>{new Compressor(t,{quality:d,maxWidth:1920,maxHeight:1920,success(r){const l=new File([r],t.name,{type:t.type,lastModified:Date.now()});n.items.add(l),document.getElementById("image-compressed").files=n.files,document.getElementById("file_size").value=l.size,s()},error(r){console.error(`Compression error for ${t.name}:`,r),o(r)}})})}
