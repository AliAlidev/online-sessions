import{g as y}from"./auth-CrJnzGtq.js";async function k(){var e=$("#global-event-data").val(),t=$("#global-event-data").data("eventGalleryUrl");if($("#global-event-data").data("eventHasP"))if(localStorage.getItem(e)){var a=await y();axios.post(t,{_token:document.querySelector('meta[name="csrf-token"]').getAttribute("content"),password:localStorage.getItem(e)},{headers:{pageToken:a}}).then(s=>{s.data.success?setTimeout(()=>{document.querySelector(".main-container").classList.remove("auth-checking"),h()},5):f()}).catch(s=>{f()})}else f();else setTimeout(()=>{document.querySelector(".main-container").classList.remove("auth-checking"),h()},5)}async function I(){var t,a;const e=await y();try{if(!(await fetch("/events/check-token",{method:"GET",headers:{pageToken:e}})).ok)throw new Error("Unauthorized");k()}catch{window.location.href=((a=(t=document.getElementById("main-page-url"))==null?void 0:t.dataset)==null?void 0:a.url)||"/"}}I();function h(){const e=document.getElementById("page-loader");e&&(e.style.display="none")}async function f(){var e=$("#global-event-data").data("url"),t=await y();axios.get(e,{headers:{pageToken:t}}).then(a=>{window.location.href=a.data.url}).catch(a=>{console.log(a)})}const c=document.getElementById("dropArea"),g=document.getElementById("image"),m=document.getElementById("thumbnails");c.addEventListener("click",()=>{g.click()});g.addEventListener("change",B);c.addEventListener("dragover",e=>{e.preventDefault(),c.classList.add("dragover")});c.addEventListener("dragleave",()=>{c.classList.remove("dragover")});c.addEventListener("drop",e=>{e.preventDefault(),c.classList.remove("dragover"),g.files=e.dataTransfer.files,B()});function B(){const e=g.files;if(m.innerHTML="",e.length>0){m.style.marginTop="15px";for(const t of e)if(t&&t.type.startsWith("image/")){const a=new FileReader;a.onload=function(s){const i=document.createElement("img");i.src=s.target.result,m.appendChild(i)},a.readAsDataURL(t)}}else m.style.marginTop="0"}function w(){const e=document.getElementById("overlay");e.classList.remove("show"),e.addEventListener("transitionend",()=>{e.classList.add("hidden")},{once:!0})}document.getElementById("closeModalBtn").addEventListener("click",w);document.getElementById("closeXBtn").addEventListener("click",w);$("#uploadForm").submit(async function(e){e.preventDefault(),$(".alert").remove(),$(".image-error").attr("hidden",!0);var t=$("#storeButton");S(t),await L();var a=$("#image-compressed")[0].files[0];if(!a)return $(".image-error").attr("hidden",!1),$(".image-error").text("Please select image"),v(t),!1;$(".upload-image-btn").attr("disabled",!0),$("#closeModalBtn").attr("disabled",!0),b($(".upload-image-btn")),b($("#closeModalBtn"));var s=$("#uploadProgressModal #progressContainer");const i=document.getElementById("overlay");i.classList.remove("hidden"),setTimeout(()=>i.classList.add("show"),10),s.empty();let d=$(`
                <div class="mb-4" id="file-container-0" style="margin-top:10px">
                    <p class="mb-0">Stage1: File Upload ${a.name}</p>
                    <div class="progress" style="margin-top:10px">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                            style="width: 0%;" id="progress-bar-0"></div>
                    </div>
                    <div class='d-inline-block'>
                        <p id="status-0" class="text-danger mt-3" style="text-align:start; margin-top:10px"></p>
                        <button class="btn btn-sm btn-warning retry-btn hidden-force mt-3" style="height:15px; width:auto; font-size:12px; margin-top:10px; text-align:start" data-index="0">Retry</button>
                    </div>
                </div>
            `);s.append(d),E(a,0).then(n=>{var r;clearInterval($("#status-0").data("interval")),$("#progress-bar-0").removeClass("bg-success").addClass("bg-primary").text("Completed"),$("#status-0").addClass("hidden-force"),v(t),$("#uploadForm")[0].reset(),document.getElementById("thumbnails").innerHTML="";const l=((r=n.data)==null?void 0:r.message)||"Upload completed successfully",o=$(`<div class="alert alert-success guest-upload-success" style=""><i class="fa fa-check" aria-hidden="true"></i>${l}</div>`);$("#uploadProgressModal").prepend(o),$("#uploadProgressModalLabel").attr("hidden",!0),p($(".upload-image-btn")),p($("#closeModalBtn"))}).catch(n=>{v(t),console.error("Upload failed:",n)})});function b(e){e.attr("disabled",!0),e.css("background-color","grey")}function p(e){var t=$("#button-main-color").val();e.attr("disabled",!1),e.css("background-color",t)}async function E(e,t,a){let s=new FormData;s.append("file",e);var i=$('meta[name="csrf-token"]').attr("content"),d=$("#event_id").data("id");s.append("_token",i),s.append("user_name",$("#user_name").val()),s.append("description",$("#caption").val()),s.append("file_size",$("#file_size").val()),s.append("event_id",d);var n=document.getElementById("share-post-btn").dataset.url;$(`#file-container-${t} .start-btn`).remove();try{return await axios.post(n,s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:function(r){if(r.lengthComputable){const u=Math.round(r.loaded/r.total*100);$(`#progress-bar-${t}`).css("width",u+"%").text(u+"%"),u===100&&M(0)}},timeout:999e3})}catch(o){var l=o.response.data.message;const r=$(`<div class="alert alert-danger guest-upload-danger" style=""><i class="fa fa-close" aria-hidden="true"></i>${l}</div>`);$(".alert-danger").remove(),$(".alert-success").remove(),$("#uploadProgressModal").prepend(r),p($("#closeModalBtn")),p($(".upload-image-btn"));let u=$("#status-"+t);throw u.text("Stage2: Failed"),clearInterval(u.data("interval")),x(0),o}}function M(e){let t=$("#status-"+e),a=0;t.removeClass("hidden-force"),t.text("Stage2: Processing");let s=setInterval(()=>{a=(a+1)%4,t.text("Stage2: Processing"+".".repeat(a))},500);t.data("interval",s)}function x(e){$(`#file-container-${e} .retry-btn`).removeClass("hidden-force")}$(document).on("click",".retry-btn",function(e){e.preventDefault(),$(this).addClass("hidden-force");var t=$("#image-compressed")[0].files[0];$("#progress-bar-0").css("width","0%").removeClass("bg-danger").addClass("bg-success").text("0%"),$("#status-0").text("Stage2: Retrying..."),E(t,0)});function S(e){const t=document.getElementById("spinner");t.style.display="inline-block",e.disabled=!0}function v(e){const t=document.getElementById("spinner");t.style.display="none",e.disabled=!1}async function L(){const t=document.getElementById("image").files[0];if(!t)return;let a=[];try{const n=document.getElementById("compression-ratios-file-path"),l=await fetch(n.value);if(!l.ok)throw new Error(`Failed to fetch compression ratios: ${l.status}`);a=await l.json()}catch(n){console.error("Error loading compression ratios:",n),a=[{minSizeMB:10,quality:.7},{minSizeMB:9,quality:.75},{minSizeMB:8,quality:.8},{minSizeMB:7,quality:.85},{minSizeMB:6,quality:.9},{minSizeMB:5,quality:.91},{minSizeMB:4,quality:.92},{minSizeMB:3,quality:.93},{minSizeMB:2,quality:.94},{minSizeMB:1,quality:.95},{minSizeMB:.5,quality:.99}]}const s=new DataTransfer,i=t.size/(1024*1024);let d=null;for(const n of a)if(i>n.minSizeMB){d=Math.max(n.quality,.7);break}if(d===null){s.items.add(t),document.getElementById("image-compressed").files=s.files,document.getElementById("file_size").value=t.size;return}return new Promise((n,l)=>{new Compressor(t,{quality:d,maxWidth:1920,maxHeight:1920,success(o){const r=new File([o],t.name,{type:t.type,lastModified:Date.now()});s.items.add(r),document.getElementById("image-compressed").files=s.files,document.getElementById("file_size").value=r.size,n()},error(o){console.error(`Compression error for ${t.name}:`,o),l(o)}})})}
